name: Sync Strava Data

on:
  schedule:
    - cron: '0 21 * * *'  # 4 AM Jakarta
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Fetch Strava Data
        env:
          STRAVA_CLIENT_ID: ${{ secrets.STRAVA_CLIENT_ID }}
          STRAVA_CLIENT_SECRET: ${{ secrets.STRAVA_CLIENT_SECRET }}
          STRAVA_REFRESH_TOKEN: ${{ secrets.STRAVA_REFRESH_TOKEN }}
        run: |
          echo "Refreshing token..."
          TOKEN_RESPONSE=$(curl -s -X POST "https://www.strava.com/oauth/token" \
            -d "client_id=${STRAVA_CLIENT_ID}" \
            -d "client_secret=${STRAVA_CLIENT_SECRET}" \
            -d "grant_type=refresh_token" \
            -d "refresh_token=${STRAVA_REFRESH_TOKEN}")
          
          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r '.access_token')
          
          if [ "$ACCESS_TOKEN" = "null" ]; then
            echo "Token refresh failed"; exit 1
          fi
          echo "✓ Token refreshed"
          
          # Fetch activities
          echo "[]" > /tmp/all.json
          for page in 1 2 3 4 5 6 7 8 9 10; do
            curl -s -H "Authorization: Bearer $ACCESS_TOKEN" \
              "https://www.strava.com/api/v3/athlete/activities?page=${page}&per_page=200" > /tmp/page.json
            COUNT=$(jq 'length' /tmp/page.json)
            echo "Page $page: $COUNT"
            [ "$COUNT" = "0" ] && break
            jq -s '.[0] + .[1]' /tmp/all.json /tmp/page.json > /tmp/merged.json
            mv /tmp/merged.json /tmp/all.json
            [ "$COUNT" -lt 200 ] && break
          done
          cp /tmp/all.json data/activities.json
          echo "✓ $(jq 'length' data/activities.json) activities"

      - name: Generate Stats
        run: |
          # Use ISO week boundaries (Monday-Sunday) instead of rolling 7 days
          THIS_WEEK_START=$(date -d "last monday" +%Y-%m-%d)
          # If today is Monday, "last monday" gives today, which is correct
          if [ "$(date +%u)" = "1" ]; then
            THIS_WEEK_START=$(date +%Y-%m-%d)
          fi
          LAST_WEEK_START=$(date -d "$THIS_WEEK_START - 7 days" +%Y-%m-%d)
          TODAY=$(date +%Y-%m-%d)
          CURRENT_YEAR=$(date +%Y)
          
          echo "This week starts: $THIS_WEEK_START"
          echo "Last week starts: $LAST_WEEK_START"
          
          jq --arg tws "$THIS_WEEK_START" --arg lws "$LAST_WEEK_START" --arg td "$TODAY" --arg cy "$CURRENT_YEAR" '
            [.[] | select(.type == "Run")] as $r |
            ($cy + "-01-01") as $yearStart |
            {
              current_year: $cy,
              ytd_2026: ([$r[] | select(.start_date_local >= "2026-01-01" and .start_date_local < "2027-01-01")] | {runs: length, distance_km: (if length>0 then [.[].distance]|add/1000|.*10|round/10 else 0 end), time_hrs: (if length>0 then [.[].moving_time]|add/3600|.*10|round/10 else 0 end)}),
              ytd_2025_same_period: ([$r[] | select(.start_date_local >= "2025-01-01" and .start_date_local < ("2025-" + $td[5:10]))] | {runs: length, distance_km: (if length>0 then [.[].distance]|add/1000|.*10|round/10 else 0 end), time_hrs: (if length>0 then [.[].moving_time]|add/3600|.*10|round/10 else 0 end)}),
              ytd_2021_same_period: ([$r[] | select(.start_date_local >= "2021-01-01" and .start_date_local < ("2021-" + $td[5:10]))] | {runs: length, distance_km: (if length>0 then [.[].distance]|add/1000|.*10|round/10 else 0 end), time_hrs: (if length>0 then [.[].moving_time]|add/3600|.*10|round/10 else 0 end)}),
              full_year_2025: ([$r[] | select(.start_date_local >= "2025-01-01" and .start_date_local < "2026-01-01")] | {runs: length, distance_km: (if length>0 then [.[].distance]|add/1000|.*10|round/10 else 0 end)}),
              full_year_2021: ([$r[] | select(.start_date_local >= "2021-01-01" and .start_date_local < "2022-01-01")] | {runs: length, distance_km: (if length>0 then [.[].distance]|add/1000|.*10|round/10 else 0 end)}),
              this_week: ([$r[] | select(.start_date_local[0:10] >= $tws)] | {runs: length, distance_km: (if length>0 then [.[].distance]|add/1000|.*10|round/10 else 0 end), time_min: (if length>0 then [.[].moving_time]|add/60|round else 0 end)}),
              last_week: ([$r[] | select(.start_date_local[0:10] >= $lws and .start_date_local[0:10] < $tws)] | {runs: length, distance_km: (if length>0 then [.[].distance]|add/1000|.*10|round/10 else 0 end), time_min: (if length>0 then [.[].moving_time]|add/60|round else 0 end)}),
              weekly_goal: 3,
              lastRun: ($r | sort_by(.start_date_local) | last | {date: .start_date_local[0:10], distance: ((.distance/1000*100|round)/100|tostring), pace: (((.moving_time/60)/(.distance/1000)*100|round)/100|tostring)}),
              updated_at: ($td + "T" + (now | strftime("%H:%M:%S")) + "+07:00")
            }' data/activities.json > data/stats.json
          echo "✓ Stats generated"

      - name: Generate Weekly Data
        run: |
          jq '[.[] | select(.type == "Run")] | group_by(.start_date_local[0:4]) | map({year: .[0].start_date_local[0:4], total_runs: length, total_distance: ([.[].distance]|add/1000|.*10|round/10), weeks: (group_by(.start_date_local[0:10] | strptime("%Y-%m-%d") | strftime("%Y-W%V")) | map({week_num: (.[0].start_date_local[0:10] | strptime("%Y-%m-%d") | strftime("%V") | tonumber), runs: length, distance_km: ([.[].distance]|add/1000|.*10|round/10)}))})' data/activities.json > data/weekly.json
          echo "✓ Weekly data generated"

      - name: Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: sync strava data"
          file_pattern: "data/*.json"
